### Idempotency Key

Параллельная отправка запросов может привести к дублированию, повторному выполнению запроса. Для предотвращения этого используем один случайно сгенерированный айдишник, который передаем с запросом - либо мы отправляем запросы параллельно, либо пытаемся запрос ретраить при падении или еще какой-ошибке.

Идемпотентностью обладают GET, HEAD, PUT, DELETE запросы.

Запросы с айдишниками складываются в базу, могут иметь несколько статусов, и, например, хранить ответ, для мгновенной отдачи - как будто он был выполнен только что. При несовпадении запроса в базе и пришедшего запроса стоит отдавать ошибку.

### Переотправка запросов (Retry pattern)

Переотправка запросов используется когда мы знаем, что ошибка носит временный характер, что сервис может находиться под пиковой нагрузкой и ответить таймаутом. Не стоит прикручивать ретрай везде и делать его безграничным, без количества лимитов.

Стратегии ожидания бывает слудющие:

-   **_без ожидания (no delay)_**, когда сразу без паузы повторяем отправку запроса
-   **_с константным значением (constant)_**, когда устанавливаем строго заданный лимит
-   **_с линейным значением (linear)_**
-   **_с экспоненциальным значением (exponencial)_**

### Circuit Breaker pattern

Паттерн, который обычно реализуется как реверс прокси-сервер и стоит перед каким-либо ресурсом. Этот прокси имеет 3 состояния - open, half-open, close.

**close** - соединение замкнуто - сервис доступен.
**half-open** - приоткрыто, состояние, когда сервис пытается переподняться, но еще не уверен, что он полностью восстановился от сбоев.
**open** - соединение разомкнуто - сервис недоступен.

Суть в том, то прокси логгирует ошибки и отмечает их на счетчике, если количество ошибок перевалило за доступный лимит, то он переходит в состояние open и отрубает сервис от внешнего мира. Через какой-то промежуток времени прокси перезходит в состояние half-open и пропускает только часть запросов для проверки того, восстановился ли сервис. Если падает хоть один запрос, то сервис уходит обратно в состояние open.
